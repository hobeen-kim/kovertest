# .github/workflows/diff-coverage.yml
name: Diff Coverage (Kover + diff-cover)

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]  # ì„ íƒ: ë©”ì¸ì—ë„ ì£¼ê¸°ì ìœ¼ë¡œ ì¸¡ì •

jobs:
  diff-coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write   # (ì„ íƒ) PR ì½”ë©˜íŠ¸/ì—…ë¡œë“œ ì‹œ í•„ìš”

    env:
      THRESHOLD: "80"        # ë³€ê²½ë¶„ ì»¤ë²„ë¦¬ì§€ ìµœì†Œ ê¸°ì¤€
      COVER_XML: build/reports/kover/report.xml

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0     # merge-base ê³„ì‚°/ì „ì²´ diff ìœ„í•´ í•„ìˆ˜

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Build & Test with Kover XML
        run: ./gradlew --no-daemon clean test koverXmlReport

      - name: Verify coverage XML exists
        run: |
          test -f "${{ env.COVER_XML }}" || {
            echo "Coverage XML not found at ${{ env.COVER_XML }}"; exit 1;
          }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install diff-cover
        run: pip install diff-cover

      # 1) CI ë¡œê·¸ìš© ì»¬ëŸ¬ í…ìŠ¤íŠ¸(ANSI) ì¶œë ¥ + ì‹¤íŒ¨ ê¸°ì¤€ ì ìš©
      - name: Diff coverage (ANSI to log)
        run: |
          diff-cover "${{ env.COVER_XML }}" \
            --compare-branch origin/${{ github.base_ref || 'main' }} \
            --src-roots src/main/kotlin src/test/kotlin \
            --format ansi:-

      # 2) ì‚¬ëžŒìš© HTML ë¦¬í¬íŠ¸ ìƒì„±
      - name: Diff coverage (HTML)
        run: |
          diff-cover "${{ env.COVER_XML }}" \
            --compare-branch origin/${{ github.base_ref || 'main' }} \
            --src-roots src/main/kotlin src/test/kotlin \
            --format html:diff-cover.html

      # 3) PR ì½”ë©˜íŠ¸/ë¦¬ë·°ìš© Markdown
      - name: Diff coverage (Markdown & JSON)
        run: |
          diff-cover "${{ env.COVER_XML }}" \
            --compare-branch origin/${{ github.base_ref || 'main' }} \
            --src-roots src/main/kotlin src/test/kotlin \
            --format markdown:diff-cover.md

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: diff-cover-reports
          path: |
            diff-cover.html

      - name: Publish Unit Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()   # ì‹¤íŒ¨í•´ë„ ì‹¤í–‰ë˜ê²Œ
        with:
          files: build/test-results/test/*.xml

      - name: Add coverage to PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.7.2
        with:
          paths: ${{ github.workspace }}/${{ env.COVER_XML }}
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 0
          min-coverage-changed-files: 0
          comment-type: "summary"
          pass-emoji: ':green_circle:'
          fail-emoji: ':red_circle:'

      - name: Merge coverage reports
        run: |
          echo "# ðŸ“Š Test Coverage Report" > pr-comment.md
          echo "" >> pr-comment.md
          echo "- **ì „ì²´ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€: ${{ steps.jacoco.outputs.coverage-overall }}%**" >> pr-comment.md
          echo "- ìˆ˜ì •ëœ íŒŒì¼ì˜ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€: ${{ steps.jacoco.outputs.coverage-changed-files }}%" >> pr-comment.md
          echo "" >> pr-comment.md
          echo "## ðŸ” ì»¤ë°‹ëœ ë‚´ìš©ì˜ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€" >> pr-comment.md
          echo "" >> pr-comment.md
          echo "|Files|Diff Coverage (%)|Missing lines|" >> pr-comment.md
          echo "|-----|-----------------|--------------|" >> pr-comment.md

          # diff-cover ê²°ê³¼ë¥¼ í…Œì´ë¸”ë¡œ ë³€í™˜
          tail -n +3 diff-cover.md | while read -r line; do
            if [[ "$line" == "## Summary"* ]]; then
              break
            fi
          
            if [[ -z "$line" ]]; then
              continue
            fi
          
            file=$(echo "$line"    | sed -E 's/^- ([^(]+) .*/\1/')
            percent=$(echo "$line" | sed -E 's/.*\(([0-9.]+%)\).*/\1/')
            missing=$(echo "$line" | grep -o 'Missing lines.*' | sed -E 's/Missing lines //')
            if [ -z "$missing" ]; then missing=" "; fi
          
            # ê²½ë¡œ ì•ž 6ê°œ ì»´í¬ë„ŒíŠ¸ ì œê±°
            short_file=$(echo "$file" | cut -d'/' -f7-)

            echo "|$short_file|$percent|$missing|" >> pr-comment.md
          done

          echo "" >> pr-comment.md
          
          # Summary ë¸”ë¡ë¶€í„° ë‹¤ì‹œ ì¶”ê°€
          awk 'BEGIN{flag=0; inblock=0}
            /^## Summary/ {flag=1}
            flag {
            if ($0 ~ /^```/) {
            if (inblock==0) { print "```diff"; inblock=1; next }
            else { inblock=0; print "```"; next }
          }
            print
          }' diff-cover.md >> pr-comment.md

      - name: Post PR comment (sticky)
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: pr-comment.md
