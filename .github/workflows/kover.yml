# .github/workflows/diff-coverage.yml
name: Diff Coverage (Kover + diff-cover)

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]  # ì„ íƒ: ë©”ì¸ì—ë„ ì£¼ê¸°ì ìœ¼ë¡œ ì¸¡ì •

jobs:
  diff-coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write   # (ì„ íƒ) PR ì½”ë©˜íŠ¸/ì—…ë¡œë“œ ì‹œ í•„ìš”

    env:
      THRESHOLD: "80"        # ë³€ê²½ë¶„ ì»¤ë²„ë¦¬ì§€ ìµœì†Œ ê¸°ì¤€
      COVER_XML: build/reports/kover/report.xml

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0     # merge-base ê³„ì‚°/ì „ì²´ diff ìœ„í•´ í•„ìˆ˜

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Build & Test with Kover XML
        run: ./gradlew --no-daemon clean test koverXmlReport

      - name: Verify coverage XML exists
        run: |
          test -f "${{ env.COVER_XML }}" || {
            echo "Coverage XML not found at ${{ env.COVER_XML }}"; exit 1;
          }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install diff-cover
        run: pip install diff-cover

      # 1) CI ë¡œê·¸ìš© ì»¬ëŸ¬ í…ìŠ¤íŠ¸(ANSI) ì¶œë ¥ + ì‹¤íŒ¨ ê¸°ì¤€ ì ìš©
      - name: Diff coverage (ANSI to log)
        run: |
          diff-cover "${{ env.COVER_XML }}" \
            --compare-branch origin/${{ github.base_ref || 'main' }} \
            --src-roots src/main/kotlin src/test/kotlin \
            --format ansi:-

      # 2) ì‚¬ëžŒìš© HTML ë¦¬í¬íŠ¸ ìƒì„±
      - name: Diff coverage (HTML)
        run: |
          diff-cover "${{ env.COVER_XML }}" \
            --compare-branch origin/${{ github.base_ref || 'main' }} \
            --src-roots src/main/kotlin src/test/kotlin \
            --format html:diff-cover.html

      # 3) PR ì½”ë©˜íŠ¸/ë¦¬ë·°ìš© Markdown
      - name: Diff coverage (Markdown & JSON)
        run: |
          diff-cover "${{ env.COVER_XML }}" \
            --compare-branch origin/${{ github.base_ref || 'main' }} \
            --src-roots src/main/kotlin src/test/kotlin \
            --report-title "Test Coverage Report" \
            --format markdown:diff-cover.md

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: diff-cover-reports
          path: |
            diff-cover.html

      - name: Publish Unit Test Results
        uses: dorny/test-reporter@v1
        if: always()  # í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ì—¬ë„ Reportë¥¼ ë³´ê¸° ìœ„í•´ `always`ë¡œ ì„¤ì •
        with:
          name: Test Report
          path: build/test-results/**/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Add coverage to PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.7.2
        with:
          paths: ${{ github.workspace }}/${{ env.COVER_XML }}
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 0
          min-coverage-changed-files: 0
          comment-type: "summary"
          pass-emoji: ':green_circle:'
          fail-emoji: ':red_circle:'

      - name: Merge coverage reports
        run: |
          echo "### ðŸ“Š Coverage Report" > pr-comment.md
          echo "" >> pr-comment.md
          echo "- Overall coverage: ${{ steps.jacoco.outputs.coverage-overall }}" >> pr-comment.md
          echo "- Changed files coverage: ${{ steps.jacoco.outputs.coverage-changed-files }}" >> pr-comment.md
          echo "" >> pr-comment.md
          echo "### ðŸ” Diff Coverage" >> pr-comment.md
          cat diff-cover.md >> pr-comment.md

      - name: Post PR comment (sticky)
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: pr-comment.md
